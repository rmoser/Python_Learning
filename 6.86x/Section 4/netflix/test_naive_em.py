import naive_em
import pytest
import numpy as np
import os, pathlib
import common

curdir = pathlib.Path(os.path.abspath(os.path.curdir))
for d in ('6.86x', 'Section 4', 'netflix'):
    if (curdir / d).exists():
        curdir = curdir / d

X = np.loadtxt(curdir / "toy_data.txt")

def test_estep_0():
    m, p = common.init(X, 3, 0)
    p, ll = naive_em.estep(X, m)
    assert ll == pytest.approx(-1388.081800044)
    assert p == pytest.approx(np.array([[0.07732478, 0.52012035, 0.40255486],
       [0.05265167, 0.51344237, 0.43390596],
       [0.05209853, 0.51935252, 0.42854895],
       [0.05301919, 0.52551335, 0.42146746],
       [0.06119004, 0.52540392, 0.41340604],
       [0.05909062, 0.52465988, 0.41624951],
       [0.07599348, 0.51676855, 0.40723797],
       [0.05453387, 0.52628911, 0.41917703],
       [0.06815466, 0.52134245, 0.41050289],
       [0.06221176, 0.51664815, 0.42114009],
       [0.06256089, 0.51498224, 0.42245687],
       [0.05742595, 0.52137825, 0.4211958 ],
       [0.10027945, 0.51944555, 0.380275  ],
       [0.05925671, 0.52493161, 0.41581168],
       [0.06860412, 0.52641277, 0.40498311],
       [0.07313998, 0.51863348, 0.40822654],
       [0.05899998, 0.51444819, 0.42655183],
       [0.05223143, 0.50570795, 0.44206062],
       [0.06957629, 0.52336734, 0.40705637],
       [0.05995998, 0.52050211, 0.41953792],
       [0.06461789, 0.52443595, 0.41094615],
       [0.09084646, 0.52058005, 0.38857349],
       [0.06444581, 0.50695723, 0.42859696],
       [0.06880659, 0.52840739, 0.40278603],
       [0.06313413, 0.53214635, 0.40471952],
       [0.06827171, 0.5285915 , 0.4031368 ],
       [0.05353635, 0.52378739, 0.42267626],
       [0.07443322, 0.53085577, 0.39471101],
       [0.06975508, 0.52798804, 0.40225688],
       [0.08293248, 0.53064505, 0.38642247],
       [0.05343572, 0.51533603, 0.43122825],
       [0.06725089, 0.53230419, 0.40044492],
       [0.07110406, 0.523967  , 0.40492894],
       [0.06988343, 0.52248611, 0.40763046],
       [0.05728414, 0.52485633, 0.41785954],
       [0.06778838, 0.52718226, 0.40502936],
       [0.07209904, 0.51613265, 0.41176831],
       [0.07591994, 0.51677749, 0.40730257],
       [0.05479929, 0.52530275, 0.41989795],
       [0.06327012, 0.53354633, 0.40318354],
       [0.07071493, 0.519306  , 0.40997907],
       [0.06269323, 0.52742591, 0.40988086],
       [0.08547253, 0.52940356, 0.38512391],
       [0.04694977, 0.49107355, 0.46197669],
       [0.05928612, 0.52015778, 0.4205561 ],
       [0.05721586, 0.52062638, 0.42215777],
       [0.07452886, 0.51378892, 0.41168222],
       [0.0664634 , 0.52550642, 0.40803018],
       [0.06795232, 0.52892037, 0.40312731],
       [0.06919314, 0.52305594, 0.40775092],
       [0.07024525, 0.51828535, 0.4114694 ],
       [0.12575265, 0.52367201, 0.35057533],
       [0.03462223, 0.51139224, 0.45398553],
       [0.38226758, 0.37258208, 0.24515034],
       [0.023661  , 0.46422263, 0.51211638],
       [0.03366285, 0.50912283, 0.45721432],
       [0.09523872, 0.53363914, 0.37112215],
       [0.04398676, 0.51448711, 0.44152613],
       [0.09227335, 0.53029564, 0.37743101],
       [0.04728496, 0.52837867, 0.42433636],
       [0.16558192, 0.49244692, 0.34197116],
       [0.0609715 , 0.53338505, 0.40564345],
       [0.03186061, 0.49512589, 0.4730135 ],
       [0.16790253, 0.49762754, 0.33446993],
       [0.05824137, 0.52678292, 0.4149757 ],
       [0.1685947 , 0.49831692, 0.33308838],
       [0.12359405, 0.52222304, 0.35418291],
       [0.04262717, 0.49657605, 0.46079678],
       [0.06054673, 0.53547689, 0.40397638],
       [0.05652811, 0.53191861, 0.41155328],
       [0.0585114 , 0.50361393, 0.43787467],
       [0.0592318 , 0.53244918, 0.40831902],
       [0.15713996, 0.50732487, 0.33553517],
       [0.14146178, 0.45595971, 0.40257851],
       [0.40684051, 0.3574816 , 0.23567788],
       [0.12786304, 0.51573983, 0.35639712],
       [0.043272  , 0.5257192 , 0.4310088 ],
       [0.10379555, 0.52780304, 0.36840142],
       [0.0504655 , 0.52203725, 0.42749725],
       [0.04768337, 0.5215732 , 0.43074344],
       [0.04703172, 0.50943182, 0.44353646],
       [0.0290608 , 0.48641773, 0.48452147],
       [0.17110871, 0.50070909, 0.32818221],
       [0.06234335, 0.53190572, 0.40575093],
       [0.04001523, 0.51125199, 0.44873278],
       [0.08603665, 0.52474106, 0.38922229],
       [0.09956292, 0.51660186, 0.38383522],
       [0.01576677, 0.40082274, 0.5834105 ],
       [0.06630224, 0.53754603, 0.39615173],
       [0.11630934, 0.51702959, 0.36666106],
       [0.05710488, 0.52812896, 0.41476616],
       [0.08983326, 0.53684246, 0.37332428],
       [0.04736271, 0.52412641, 0.42851088],
       [0.0268729 , 0.48774403, 0.48538308],
       [0.23557288, 0.46395472, 0.30047239],
       [0.16494915, 0.50105083, 0.33400001],
       [0.0438235 , 0.52528786, 0.43088865],
       [0.03870111, 0.51899284, 0.44230605],
       [0.04319955, 0.52560834, 0.43119211],
       [0.09068867, 0.5105948 , 0.39871652],
       [0.03448792, 0.49447627, 0.47103581],
       [0.0632226 , 0.53110167, 0.40567573],
       [0.05155812, 0.52856028, 0.4198816 ],
       [0.03502241, 0.51188707, 0.45309052],
       [0.06872985, 0.53718961, 0.39408054],
       [0.13547454, 0.51989701, 0.34462844],
       [0.10602076, 0.52228337, 0.37169587],
       [0.06595523, 0.51175858, 0.42228619],
       [0.09201486, 0.5361641 , 0.37182104],
       [0.1174299 , 0.52099138, 0.36157872],
       [0.02909361, 0.4954948 , 0.47541158],
       [0.03580927, 0.4987476 , 0.46544314],
       [0.05967278, 0.53699369, 0.40333353],
       [0.04170828, 0.44323036, 0.51506136],
       [0.05304267, 0.53297197, 0.41398537],
       [0.05112483, 0.52000002, 0.42887515],
       [0.08752035, 0.51420096, 0.39827869],
       [0.08427112, 0.52924325, 0.38648563],
       [0.04530434, 0.52079954, 0.43389612],
       [0.07724148, 0.53839707, 0.38436145],
       [0.06675706, 0.53676267, 0.39648027],
       [0.30610274, 0.4051098 , 0.28878747],
       [0.06612671, 0.53544941, 0.39842388],
       [0.02637659, 0.45080209, 0.52282133],
       [0.03633203, 0.49146995, 0.47219802],
       [0.05403383, 0.53033806, 0.41562811],
       [0.0290382 , 0.49514756, 0.47581424],
       [0.0448459 , 0.52749762, 0.42765648],
       [0.04045092, 0.49180313, 0.46774595],
       [0.15050422, 0.48915297, 0.3603428 ],
       [0.11441602, 0.51975696, 0.36582702],
       [0.13288835, 0.51865903, 0.34845262],
       [0.1019465 , 0.53132765, 0.36672585],
       [0.06710545, 0.4367695 , 0.49612505],
       [0.1584203 , 0.4838582 , 0.3577215 ],
       [0.12363202, 0.52428711, 0.35208088],
       [0.07093888, 0.53243409, 0.39662704],
       [0.08239573, 0.5382268 , 0.37937747],
       [0.06970376, 0.5330724 , 0.39722384],
       [0.0788211 , 0.50458576, 0.41659314],
       [0.06794808, 0.53482713, 0.39722479],
       [0.03236515, 0.49565787, 0.47197698],
       [0.02018881, 0.44581447, 0.53399673],
       [0.03242459, 0.49363882, 0.47393659],
       [0.05012699, 0.53156982, 0.41830319],
       [0.05726091, 0.52535643, 0.41738267],
       [0.11901887, 0.52321253, 0.3577686 ],
       [0.05485226, 0.53371544, 0.4114323 ],
       [0.05576549, 0.53366086, 0.41057365],
       [0.02752969, 0.48996265, 0.48250766],
       [0.65997956, 0.1910725 , 0.14894794],
       [0.97559541, 0.0113916 , 0.01301299],
       [0.59533575, 0.2383577 , 0.16630655],
       [0.34781682, 0.38615628, 0.2660269 ],
       [0.9396694 , 0.02929773, 0.03103287],
       [0.52377181, 0.28290869, 0.1933195 ],
       [0.48996321, 0.30506769, 0.2049691 ],
       [0.61126801, 0.22810546, 0.16062653],
       [0.85984422, 0.0764174 , 0.06373838],
       [0.67610265, 0.18873774, 0.13515961],
       [0.73807166, 0.15044191, 0.11148643],
       [0.67120271, 0.19054289, 0.13825439],
       [0.91723007, 0.04366788, 0.03910205],
       [0.39728106, 0.36235421, 0.24036473],
       [0.68006609, 0.18615729, 0.13377663],
       [0.76686678, 0.12992075, 0.10321247],
       [0.64580575, 0.20743229, 0.14676196],
       [0.39004413, 0.36795187, 0.242004  ],
       [0.85542518, 0.07920528, 0.06536954],
       [0.93222915, 0.03439221, 0.03337864],
       [0.36036031, 0.38299148, 0.25664822],
       [0.86405637, 0.07459915, 0.06134448],
       [0.42074222, 0.34048738, 0.2387704 ],
       [0.58136167, 0.24783813, 0.1708002 ],
       [0.79031731, 0.11862916, 0.09105353],
       [0.85792325, 0.07824407, 0.06383268],
       [0.80684254, 0.10814488, 0.08501257],
       [0.4497459 , 0.32904907, 0.22120503],
       [0.51677401, 0.27753961, 0.20568639],
       [0.48496878, 0.30667284, 0.20835838],
       [0.67237796, 0.19030136, 0.13732068],
       [0.63352482, 0.21007142, 0.15640376],
       [0.38377012, 0.37245211, 0.24377777],
       [0.85421903, 0.08000862, 0.06577234],
       [0.48626759, 0.30139898, 0.21233343],
       [0.74245947, 0.14064218, 0.11689835],
       [0.72167006, 0.16063354, 0.1176964 ],
       [0.7043899 , 0.16682413, 0.12878597],
       [0.39447115, 0.36571405, 0.2398148 ],
       [0.77919377, 0.12532873, 0.09547751],
       [0.84645911, 0.08480396, 0.06873693],
       [0.76649008, 0.13242879, 0.10108113],
       [0.40584321, 0.35754197, 0.23661482],
       [0.45648025, 0.32597292, 0.21754683],
       [0.875334  , 0.06798388, 0.05668212],
       [0.22942043, 0.46633269, 0.30424687],
       [0.9736247 , 0.01247901, 0.01389629],
       [0.36035713, 0.38105952, 0.25858335],
       [0.59015019, 0.24192147, 0.16792834],
       [0.2173553 , 0.46466709, 0.31797761],
       [0.18711653, 0.49064708, 0.32223639],
       [0.24066383, 0.43540745, 0.32392872],
       [0.36069043, 0.38254328, 0.2567663 ],
       [0.68211451, 0.18219368, 0.1356918 ],
       [0.60467454, 0.22975328, 0.16557218],
       [0.32342774, 0.41014888, 0.26642337],
       [0.52674816, 0.27935202, 0.19389982],
       [0.63998075, 0.2092423 , 0.15077695],
       [0.36695991, 0.3787984 , 0.25424169],
       [0.66219447, 0.19735869, 0.14044684],
       [0.97308113, 0.01280086, 0.01411801],
       [0.77739612, 0.12628882, 0.09631506],
       [0.63427048, 0.21464629, 0.15108323],
       [0.23660899, 0.46303201, 0.300359  ],
       [0.7529878 , 0.14142887, 0.10558333],
       [0.52853273, 0.27679873, 0.19466854],
       [0.9021418 , 0.05199137, 0.04586683],
       [0.61697497, 0.22316158, 0.15986345],
       [0.52250276, 0.28345161, 0.19404564],
       [0.8844227 , 0.06255459, 0.05302271],
       [0.57922247, 0.24074493, 0.18003259],
       [0.64772252, 0.19805549, 0.15422199],
       [0.60860333, 0.22912105, 0.16227562],
       [0.45725003, 0.32345364, 0.21929633],
       [0.56206884, 0.25579965, 0.18213151],
       [0.81754641, 0.10087929, 0.0815743 ],
       [0.46485183, 0.3202701 , 0.21487807],
       [0.74459515, 0.14559924, 0.10980561],
       [0.79569672, 0.10871348, 0.0955898 ],
       [0.64743377, 0.20391209, 0.14865414],
       [0.9121401 , 0.04530703, 0.04255287],
       [0.62280325, 0.22151559, 0.15568116],
       [0.21469863, 0.4767601 , 0.30854127],
       [0.69973509, 0.1730478 , 0.12721712],
       [0.71752881, 0.16285598, 0.11961521],
       [0.84968201, 0.08261205, 0.06770595],
       [0.63251055, 0.21574576, 0.15174369],
       [0.67250593, 0.18982315, 0.13767092],
       [0.71339963, 0.16432974, 0.12227063],
       [0.44437152, 0.3092087 , 0.24641977],
       [0.56439778, 0.25646162, 0.1791406 ],
       [0.29243876, 0.4287691 , 0.27879214],
       [0.75625032, 0.13913032, 0.10461936],
       [0.60524482, 0.23248972, 0.16226545],
       [0.82874548, 0.09426728, 0.07698724],
       [0.900119  , 0.05352586, 0.04635513],
       [0.49107618, 0.30224672, 0.2066771 ],
       [0.64789279, 0.20618565, 0.14592156],
       [0.64621696, 0.19942306, 0.15435998],
       [0.64408005, 0.2086027 , 0.14731725]]))

def test_estep_1():
    X = np.array([[0.85794562, 0.84725174],
         [0.6235637,  0.38438171],
         [0.29753461, 0.05671298],
         [0.27265629, 0.47766512],
         [0.81216873, 0.47997717],
         [0.3927848,  0.83607876],
         [0.33739616, 0.64817187],
         [0.36824154, 0.95715516],
         [0.14035078, 0.87008726],
         [0.47360805, 0.80091075],
         [0.52047748, 0.67887953],
         [0.72063265, 0.58201979],
         [0.53737323, 0.75861562],
         [0.10590761, 0.47360042],
         [0.18633234, 0.73691818]])

    m = common.GaussianMixture(
        np.array([[0.6235637, 0.38438171], [0.3927848, 0.83607876], [0.81216873, 0.47997717], [0.14035078, 0.87008726], [0.36824154, 0.95715516], [0.10590761, 0.47360042]])
        ,np.array([0.10038354, 0.07227467, 0.13240693, 0.12411825, 0.10497521, 0.12220856])
        ,np.array([0.1680912, 0.15835331, 0.21384187, 0.14223565, 0.14295074, 0.17452722])
    )

    p, ll = naive_em.estep(X, m)

    assert p == pytest.approx(np.array([
        [0.17354324, 0.19408461, 0.38136556, 0.0569083 , 0.16250611, 0.03159219],
        [0.39379907, 0.08689908, 0.32081103, 0.04067548, 0.04920547, 0.10860986],
        [0.35788286, 0.01907566, 0.18709725, 0.04472511, 0.01732312, 0.37389601],
        [0.19268431, 0.18091751, 0.11938917, 0.12743323, 0.09677628, 0.28279951],
        [0.36304946, 0.07311615, 0.43750366, 0.02729566, 0.04877955, 0.05025552],
        [0.07858663, 0.37039817, 0.08705556, 0.14917384, 0.21407078, 0.10071502],
        [0.13662023, 0.29150288, 0.10750309, 0.13944117, 0.14926196, 0.17567066],
        [0.04532867, 0.37841271, 0.06233585, 0.17307275, 0.2613835 , 0.07946652],
        [0.03479877, 0.30116079, 0.03560306, 0.24675099, 0.22083886, 0.16084754],
        [0.1084787 , 0.35703165, 0.12209296, 0.12356811, 0.19771701, 0.09111156],
        [0.18151437, 0.29042408, 0.1775779 , 0.09728296, 0.14845737, 0.10474333],
        [0.30076285, 0.15240546, 0.34401968, 0.04831719, 0.08817504, 0.06631978],
        [0.14424702, 0.32662602, 0.16265301, 0.10373169, 0.17686354, 0.08587872],
        [0.12020157, 0.14175102, 0.06966009, 0.17178204, 0.09140514, 0.40520014],
        [0.06707408, 0.29382796, 0.05528713, 0.20393925, 0.17797873, 0.20189285]
    ]))
    assert ll == pytest.approx(-5.592899)

def test_estep_2():
    X = np.array([
        [7.69960251e-01, 4.80482504e-01, 7.61868462e-01, 2.11672202e-01],
        [1.53847919e-01, 1.30009631e-01, 8.84109482e-01, 2.16833390e-01],
        [1.29843989e-01, 3.04396783e-01, 1.70397121e-01, 3.24032749e-01],
        [1.10264312e-01, 4.48807913e-02, 9.61893089e-01, 3.98977837e-02],
        [1.62400260e-01, 7.65309126e-01, 3.01939169e-01, 3.53857621e-01],
        [5.18054648e-01, 4.22392899e-01, 6.24613169e-01, 3.13209865e-01],
        [4.60476199e-01, 2.23442241e-01, 7.39410255e-01, 1.45645018e-01],
        [6.06434037e-01, 5.65974706e-01, 7.04468227e-01, 7.12157495e-01],
        [3.15906174e-01, 4.91512408e-01, 7.98098082e-01, 7.09894472e-01],
        [2.60332816e-04, 4.25664479e-01, 4.89359124e-01, 8.47701785e-01],
        [8.18969784e-01, 8.69891494e-01, 2.74872543e-01, 4.33065231e-01]
    ])

    m = common.GaussianMixture(
        np.array([
            [-0.41511768, -0.68736202, 0.73882557, -0.56748913],
            [0.21626335, 0.67597935, 0.95676828, -0.54352175],
            [0.7109851, -0.16993084, 0.27000576, 0.39093637],
            [0.70254086, 0.41522044, 0.51054146, -0.1435946],
            [0.92288332, 0.5828022, 0.72451918, -0.27084223],
            [-0.26910254, -0.30617934, 0.36732875, 0.25094269],
            [-0.01720674, 0.0983437, 0.9905419, -0.15141272],
            [-0.98684769, 0.7177342, -0.62508074, -0.63385679],
            [0.78480094, -0.44530718, -0.87824777, 0.42573363]
        ]),
        np.array([0.7628617, 0.33327389, 0.211824, 0.16580905, 0.25954481, 0.32005918, 0.23804639, 1.18756395, 0.85250175]),
        np.array([0.11464234, 0.1187937, 0.10175297, 0.09219597, 0.12628468, 0.08434736, 0.1032797,  0.16298212, 0.09572116])
    )
    
    p, ll = naive_em.estep(X, m)
    assert p == pytest.approx(np.array([
        [0.00539615, 0.06408583, 0.1086385, 0.4618724, 0.28003951, 0.0113546, 0.06206782, 0.00253688, 0.00400832], [0.02265466, 0.09471946, 0.1126241, 0.15701009, 0.08136552, 0.1016986, 0.4199421, 0.00545862, 0.00452686], [0.0209511, 0.05630354, 0.29748402, 0.22462352, 0.0689316, 0.17149031, 0.12357464, 0.01696563, 0.01967565], [0.02762672, 0.10909768, 0.06584769, 0.11825811, 0.0704161, 0.09152467, 0.5085946, 0.00517234, 0.00346208], [0.01655368, 0.13615747, 0.11587799, 0.32950122, 0.15896971, 0.08246875, 0.11914361, 0.02520044, 0.01612712], [0.0080293, 0.06471163, 0.18023085, 0.42042483, 0.17934627, 0.03316657, 0.10414451, 0.00413382, 0.00581221], [0.01113539, 0.07379647, 0.15720005, 0.37480572, 0.15561618, 0.04112393, 0.17849188, 0.00342735, 0.00440304], [0.01112342, 0.06542335, 0.28337972, 0.27400187, 0.22006474, 0.04172921, 0.08201955, 0.00798645, 0.0142717], [0.01942953, 0.09283045, 0.23124873, 0.18492698, 0.14309921, 0.0977409, 0.20660064, 0.01121485, 0.01290871], [0.03338162, 0.05930923, 0.26885434, 0.06464466, 0.0463076, 0.2950412, 0.17440292, 0.02878718, 0.02927125], [0.00529607, 0.05535687, 0.1358085, 0.42491926, 0.32416337, 0.01109691, 0.01586916, 0.01013007, 0.01735979]
    ]), 1e-4)

    assert ll == pytest.approx(-33.336057)

def test_run():
    pass
    
